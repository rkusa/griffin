<!DOCTYPE html>

<head>
  <title>Demo</title>
</head>

<body>
  <script src="bundle.js"></script>

  <template>
    <ul>
      <template repeat="${locals.constraints}" as="constraint">
        <li>${constraint.name} ${this.constraintCurrent(locals.parts, constraint.id)}/${constraint.max}</li>
      </template>
    </ul>
    <template repeat="${locals.parts}" as="part">
      <fieldset>
        <legend>${part.name}</legend>

        <ul>
          <template repeat="${part.products}" as="product">
            <div>

              <li>
                <template with="${this.currentVariant(product)}" as="variant">
                <label>
                  <input type="checkbox" checked="${product.selected}" on-change="e => this.selectProduct(product, e.target.checked)">
                  ${variant.name} ${variant.price}â‚¬
                </label>
                </template>

                <ul>
                  <template repeat="${product.attributes}" as="attr">
                    <li>
                      ${attr.name}
                      <select on-change="e => this.selectAttribute(product, attr, e.target.selectedIndex - 1)">
                        <option></option>
                        <optgroup repeat="${attr.options}" as="option">
                          <option value="${option.id}" selected="${option.selected}" disabled="${!this.isEnabled(product, attr.id, option.id)}">${option.name}</option>
                        </optgroup>
                      </select>
                    </li>
                  </template>
                </ul>

              </li>

            </div>
            <template if="${part.products[0].selected}">
              IF SHOWN
            </template>
          </template>
        </ul>
      </fieldset>
    </template>

    Total: ${this.calculateTotal(locals.parts)}

    <template if="${this.calculateTotal(locals.parts) > 0}">
      YES
    </template>
  </template>

  <script>
  'use strict'
  const template = document.querySelector('template')
  parseTemplate(template)
  let state = {
    constraints: [
      {
        id: 1,
        name: "RAM Slots",
        min: 1,
        max: 2,
      }
    ],
    parts: [
      {
        name: "RAM",
        constraints: [
          {
            id: 1,
            name: "RAM Slots",
            min: 1,
            max: 2,
          }
        ],
        products: [
          {
            selected: false,
            contributions: [
              [1, 1]
            ],
            data: {
              name: "1GB RAM",
              price: 10,
            },
          },
          {
            selected: false,
            'contributions': [
              [1, 1]
            ],
            attributes: [
              { id: 1, name: 'Color', options: [
                  { id: 1, name: 'Black', selected: false },
                  { id: 2, name: 'White', selected: false },
                ]
              },
              { id: 2, name: 'Size', options: [
                  { id: 1, name: 'M', selected: false },
                  { id: 2, name: 'L', selected: false },
                ]
              },
            ],
            data: {
              name: "2GB RAM",
              price: 10,
            },
            variants: [
              {
                combination: [[1, 1], [2, 1]],
                data: {
                  name: "Black, M",
                  price: 11,
                }
              },
              {
                combination: [[1, 2], [2, 2]],
                data: {
                  name: "White, L",
                  price: 12,
                }
              },
            ]
          },
          {
            selected: false,
            contributions: [
              [1, 1]
            ],
            data: {
              name: "1GB RAM",
              price: 10,
            },
          },
        ],
      }
    ],
    total: 0,
  }
  const fns = {
    isEnabled(product, attrId, optId) {
        const selectOptions = new Map()
        for (const attr of product.attributes) {
          for (const option of attr.options) {
            if (option.selected) {
              selectOptions.set(attr.id, option.id)
              break
            }
          }
        }

        if (selectOptions.size === 1 && selectOptions.has(attrId)) {
          return true
        }

        for (const variant of product.variants) {
          let valid = true
          let containsOption = false

          for (const pair of variant.combination) {
            if (pair[0] === attrId && pair[1] === optId) {
              containsOption = true
            }
            if (selectOptions.has(pair[0]) && selectOptions.get(pair[0]) !== pair[1]) {
              valid = false
              break
            }
          }

          if (valid && containsOption) {
            return true
          }
        }

        return false
    },

    selectAttribute(product, attribute, ix) {
      for (let i = 0; i < attribute.options.length; ++i) {
        attribute.options[i].selected = i === ix
      }

      rerender()
    },

    currentVariant(product) {
      if ('variants' in product) {
        const selectOptions = {}
        for (const attr of product.attributes) {
          for (const option of attr.options) {
            if (option.selected) {
              selectOptions[attr.id] = option.id
              break
            }
          }
        }

        for (const variant of product.variants) {
          let valid = true
          for (const pair of variant.combination) {
            if (selectOptions[pair[0]] !== pair[1]) {
              valid = false
              break
            }
          }

          if (valid) {
            return variant.data
          }
        }

        return product.data
      } else {
        return product.data
      }
    },

    selectProduct(product, selected) {
      product.selected = selected
      rerender()
    },

    calculateTotal(parts) {
      let total = 0
      for (const part of parts) {
        for (const product of part.products) {
          if (product.selected) {
            total += this.currentVariant(product).price
          }
        }
      }
      return total
    },

    constraintCurrent(parts, constraintId) {
      let cur = 0
      for (const part of parts) {
        for (const product of part.products) {
          if (product.selected) {
            for (const contribution of product.contributions) {
              if (contribution[0] === constraintId) {
                cur += contribution[1]
              }
            }
          }
        }
      }
      return cur
    },
  }
  const node = importNodeWithData(template.content, [state], fns)

  document.body.appendChild(node)

  // state.name = 'rkusa'
  // state = Object.assign({}, state, { name: 'rkusa' })
  function rerender() {
    for (const _ of updateNode(document.body, [state], undefined, fns)) {
    }
  }
  </script>
</body>