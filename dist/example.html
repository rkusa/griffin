<!DOCTYPE html>

<head>
  <title>Demo</title>
</head>

<body>
  <script src="bundle.js"></script>

  <template>
    <ul>
      <template repeat="${locals.products}" as="product">
        <li>
          <img src="asd.jpeg"/>
          <label>
            <input type="checkbox" checked="${product.selected}" on-change="e => this.selectProduct(product, e.target.checked)">
            ${product.data.name} ${product.data.price}â‚¬
          </label>
        </li>
        <template if="${locals.products[0].selected}">
          IF SHOWN
        </template>
      </template>
    </ul>
  </template>

  <script>
  'use strict'
  const template = document.querySelector('template')
  parseTemplate(template)
  let state = {
    products: [
      {
        selected: false,
        contributions: [
          [1, 1]
        ],
        data: {
          name: "AAAAAAAA",
          price: 10,
        },
      },
      {
        selected: false,
        contributions: [
          [1, 1]
        ],
        data: {
          name: "BBBBBBBBB",
          price: 20,
        },
      },
    ],
  }
  const fns = {
    isEnabled(product, attrId, optId) {
        const selectOptions = new Map()
        for (const attr of product.attributes) {
          for (const option of attr.options) {
            if (option.selected) {
              selectOptions.set(attr.id, option.id)
              break
            }
          }
        }

        if (selectOptions.size === 1 && selectOptions.has(attrId)) {
          return true
        }

        for (const variant of product.variants) {
          let valid = true
          let containsOption = false

          for (const pair of variant.combination) {
            if (pair[0] === attrId && pair[1] === optId) {
              containsOption = true
            }
            if (selectOptions.has(pair[0]) && selectOptions.get(pair[0]) !== pair[1]) {
              valid = false
              break
            }
          }

          if (valid && containsOption) {
            return true
          }
        }

        return false
    },

    selectAttribute(product, attribute, ix) {
      for (let i = 0; i < attribute.options.length; ++i) {
        attribute.options[i].selected = i === ix
      }

      rerender()
    },

    currentVariant(product) {
      if ('variants' in product) {
        const selectOptions = {}
        for (const attr of product.attributes) {
          for (const option of attr.options) {
            if (option.selected) {
              selectOptions[attr.id] = option.id
              break
            }
          }
        }

        for (const variant of product.variants) {
          let valid = true
          for (const pair of variant.combination) {
            if (selectOptions[pair[0]] !== pair[1]) {
              valid = false
              break
            }
          }

          if (valid) {
            return variant.data
          }
        }

        return product.data
      } else {
        return product.data
      }
    },

    selectProduct(product, selected) {
      product.selected = selected
      rerender()
    },

    calculateTotal(parts) {
      let total = 0
      for (const part of parts) {
        for (const product of part.products) {
          if (product.selected) {
            total += this.currentVariant(product).price
          }
        }
      }
      return total
    },

    constraintCurrent(parts, constraintId) {
      let cur = 0
      for (const part of parts) {
        for (const product of part.products) {
          if (product.selected) {
            for (const contribution of product.contributions) {
              if (contribution[0] === constraintId) {
                cur += contribution[1]
              }
            }
          }
        }
      }
      return cur
    },
  }
  const node = importNodeWithData(template.content, [state], fns)

  document.body.appendChild(node)

  // state.name = 'rkusa'
  // state = Object.assign({}, state, { name: 'rkusa' })
  function rerender() {
    for (const _ of updateNode(document.body, [state], undefined, fns)) {
    }
  }
  </script>
</body>